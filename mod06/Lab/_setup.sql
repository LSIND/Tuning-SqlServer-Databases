USE AdventureWorks;
GO

-- Предварительное удаление объектов
IF OBJECT_ID(N'[FK_Campaign_SalesTerritory]') IS NOT NULL
BEGIN
ALTER TABLE Proseware.Campaign
DROP CONSTRAINT IF EXISTS [FK_Campaign_SalesTerritory];
END
GO

DROP TABLE IF EXISTS Proseware.CampaignAdvert;
GO

DROP TABLE IF EXISTS Proseware.Campaign;
GO


 DROP TABLE IF EXISTS Proseware.WebResponse;
 GO

DROP SCHEMA IF EXISTS Proseware;
GO
-------

-- Создание объектов для ЛР6
CREATE SCHEMA Proseware;
GO

CREATE TABLE Proseware.Campaign
(	CampaignID int ,
	CampaignName varchar(20) NOT NULL,
	CampaignTerritoryID int NOT NULL,
	CampaignStartDate date NOT NULL,
	CampaignEndDate date NOT NULL,
	CONSTRAINT PK_Campaign PRIMARY KEY (CampaignID)
)
GO
ALTER TABLE Proseware.Campaign WITH CHECK
ADD CONSTRAINT FK_Campaign_SalesTerritory FOREIGN KEY (CampaignTerritoryID)
REFERENCES Sales.SalesTerritory(TerritoryID)
GO

ALTER TABLE Proseware.Campaign 
CHECK CONSTRAINT FK_Campaign_SalesTerritory
GO

INSERT Proseware.Campaign
(CampaignID, CampaignName, CampaignTerritoryID, CampaignStartDate, CampaignEndDate)
SELECT TOP (200)
ROW_NUMBER() OVER (ORDER BY a.name, b.name),
CAST(1000000 +ROW_NUMBER() OVER (ORDER BY a.name, b.name) AS nvarchar(20)),
(ROW_NUMBER() OVER (ORDER BY a.name, b.name) % 10) + 1,
DATEADD(dd, ROW_NUMBER() OVER (ORDER BY a.name, b.name) % 3650, '2015-01-01'),
DATEADD(dd, (ROW_NUMBER() OVER (ORDER BY a.name, b.name) % 3650) + 30, '2015-01-01')
FROM master.dbo.spt_values AS a
CROSS JOIN master.dbo.spt_values AS b
GO
UPDATE STATISTICS Proseware.Campaign;
GO

CREATE TABLE Proseware.CampaignAdvert
(	CampaignAdvertID int IDENTITY NOT NULL,
	CampaignId int NOT NULL,
	AdvertMedia varchar(30) NOT NULL,
	StartDate datetime2 NOT NULL,
	EndDate datetime2 NOT NULL,
	CONSTRAINT PK_CampaignAdvert PRIMARY KEY (CampaignAdvertID)
);
GO

ALTER TABLE Proseware.CampaignAdvert 
WITH CHECK ADD CONSTRAINT FK_CampaignAdvert_Campaign FOREIGN KEY (CampaignID)
REFERENCES Proseware.Campaign(CampaignID);
GO

ALTER TABLE Proseware.CampaignAdvert
CHECK CONSTRAINT FK_CampaignAdvert_Campaign;
GO

CREATE INDEX IX_CampaignAdvert_AdvertMedia
ON Proseware.CampaignAdvert (AdvertMedia);
GO

INSERT Proseware.CampaignAdvert (CampaignId, AdvertMedia, StartDate, EndDate)
SELECT c.CampaignID, m.media, DATEADD(dd,m.st, c.CampaignStartDate), DATEADD(dd, -1*m.ed, c.CampaignEndDate)
FROM Proseware.Campaign AS c
CROSS JOIN (VALUES ('Print - color',7,1),('Print - greyscale',6,2),('Radio',5,3),('Web',4,4),('Web',3,5)) AS m (media,st,ed)
CROSS JOIN (VALUES (1),(2)) AS v (n)
GO

CREATE TABLE Proseware.WebResponse
(	WebResponseID bigint IDENTITY NOT NULL,
	CampaignAdvertId int NOT NULL,
	log_date datetime2 NOT NULL,
	page_url varchar(200) NOT NULL,
	client_ip binary(16) NOT NULL,
	browser_name varchar(50) NOT NULL,
	page_visit_time_seconds int NOT NULL,
	CONSTRAINT PK_WebResponse PRIMARY KEY (WebResponseID)
);
GO

GO
ALTER TABLE Proseware.WebResponse 
WITH CHECK ADD CONSTRAINT FK_WebResponse_CampaignAdvert FOREIGN KEY (CampaignAdvertId)
REFERENCES Proseware.CampaignAdvert(CampaignAdvertId)
GO

ALTER TABLE Proseware.WebResponse CHECK CONSTRAINT FK_WebResponse_CampaignAdvert
GO

-- Вставка данных из файла webresponse.dat

BULK INSERT AdventureWorks.Proseware.WebResponse 
FROM N'..\Tuning-SqlServer-Databases\mod06\Lab\webresponse.dat'
WITH ( DATAFILETYPE = 'native',
       CHECK_CONSTRAINTS,
	   TABLOCK
	);

-- Обновить статистику
UPDATE STATISTICS Proseware.WebResponse[PK_WebResponse]
GO

-- Создать индекс на CampaignAdvertID и обновить статистику

CREATE INDEX IX_WebResponse_CampaignAdvertID ON Proseware.WebResponse (CampaignAdvertID)
GO
UPDATE STATISTICS Proseware.CampaignAdvert[IX_CampaignAdvert_AdvertMedia] WITH STATS_STREAM = 0x01000000020000000000000000000000D0A4C059000000003902000000000000E101000000000000A7030000A70000001E0000000000000008D0003400000000380300003800000004000A0000000000000000000000000007000000B4222F00B6A500000A000000000000000A00000000000000000000000000803FCDCCCC3D0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000010000000200000010000000000088410000204100000000000050410000804000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000130000000000000000000000000000002C000000000000006D00000000000000750000000000000008000000000000003000100000002041000000000000803F040000010024005072696E74202D20636F6C6F72FF01000000000000000A00000001000000280000002800000000000000000000000D0000005072696E74202D20636F6C6F720200000040000000000A0D000000000A00000000000000
GO
UPDATE STATISTICS Proseware.WebResponse[IX_WebResponse_CampaignAdvertID] WITH STATS_STREAM = 0x01000000020000000000000000000000767E145F000000000202000000000000AA01000000000000380300003800000004000A000000000000000000000000007F0300007F000000080013000000000000000000000000000700000014B24D00B6A50000E803000000000000E803000000000000000000000000003F6F12833A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000200000002000000140000000000404100007A4400000000000080400000004100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000003E000000000000004600000000000000100000000000000027000000000000001000140000800A44000000000000803F01000000040000100014000000DF43000000000000803F02000000040000E803000000000000
GO
CREATE INDEX IX_WebResponse_log_date_CampaignAdvertID ON Proseware.WebResponse (log_date, CampaignAdvertID)
GO
